---
header-includes:
  - \usepackage{helvet}
  - \renewcommand\familydefault{\sfdefault} 
  - \usepackage[T1]{fontenc}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{fancyhdr}
  - \usepackage{makecell}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{lastpage}
  - \usepackage{lipsum}
  - \pagestyle{fancy}
  - \fancyhead[C]{Fiscal 20`r params$fy` Operating Budget Surplus/Deficit Projection}
  - \fancyhead[R]{Quarter `r params$qt`}
  - \fancyfoot[C]{\footnotesize Page \thepage\, of\, \pageref*{LastPage}}
  - \renewcommand{\headrulewidth}{0pt}

output:
  pdf_document:
  latex_engine: xelatex
classoption: landscape
geometry: "left=.25in,right=.25in,top=.7in,bottom=.7in"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

options(knitr.table.format = "latex",
        knitr.kable.NA = '')
```

```{r }
kable(chiefs_report, booktabs = TRUE, longtable = TRUE, align = c('l', 'l', rep('r', 12))) %>%
  collapse_rows(1:2, row_group_label_position = 'stack', longtable_clean_cut = FALSE,
              latex_hline = "major", headers_to_remove = 1:2) %>%
  row_spec(0,  bold = TRUE) %>%
  row_spec(nrow(chiefs_report) - 1,  hline_after = TRUE) %>%
  row_spec(c(nrow(chiefs_report), which(chiefs_report$Service == "AGENCY TOTAL")), bold = TRUE) %>%
  column_spec(2, "20em") %>%
  column_spec(4:15, "5.1em") %>%
  kable_styling(latex_options = c("repeat_header"), font_size = 7) 

```

\newpage

### By Pillar

```{r, fig.align = "center"}

pillar <- compiled %>%
  mutate(`Pillar Name` = ifelse(is.na(`Pillar Name`), "Other", `Pillar Name`)) %>%
  group_by(`Pillar Name`) %>%
  summarize_if(is.numeric, sum)

pillar %>%
  bookHelpers::format_table_numbers() %>%
  kable(booktabs = TRUE, longtable = TRUE, align = c('l', rep('r', 4))) %>%
  row_spec(0,  bold = TRUE) %>%
  kable_styling(latex_options = c("repeat_header"), font_size = 7) 

pillar %>%
  select(label = `Pillar Name`, `Total Budget`, `Q1 Projection`, `Q1 Surplus/Deficit`) %>%
  arrange(`Pillar Name`) %>%
  bookHelpers::format_plot(
    "bar_group", set_scale = "m", set_min_y = 0, set_max_y = 1000000000,  margin_b = 50, 
    bar_anno_col = "Q1 Surplus/Deficit", bar_anno_word_positive = " surplus", bar_anno_word_negative = " deficit") %>%
  bookHelpers::export_plotly("pillars", width = "950", height = "500")

```