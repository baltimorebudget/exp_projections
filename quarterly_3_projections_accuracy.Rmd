---
title: "FY21 Projection Accuracy"
output: html_document
---
  
```{r setup, include=FALSE}
library(tidyverse)
library(rio)
library(bookHelpers)
library(kableExtra)
library(ggplot2)
library(assertthat)

knitr::opts_chunk$set(echo = FALSE)
last_year <- import("G:/Analyst Folders/Lillian/exp_projection_year/projections/quarterly_outputs/archive/FY21 Q3 Projection.xlsx")

expend <- import("G:/Fiscal Years/Fiscal 2021/Projections Year/2. Monthly Expenditure Data/Month 12_June Projections/Expenditure 2021-06_Run_9.xlsx") %>%
  filter(!is.na(`Agency ID`),
         `Fund Name` == "General") %>% 
  mutate_at(vars(ends_with("ID")), as.character)

totals <- expend %>%
  summarize_at(vars(c(`Total Budget`, `BAPS YTD EXP`)), sum, na.rm = TRUE) %>%
  rename(`FY21 Total Budget` = `Total Budget`, `FY21 Actual` = `BAPS YTD EXP`)

proj <- list(
  q1 = import("G:/Analyst Folders/Lillian/exp_projection_year/projections/quarterly_outputs/archive/FY21 Q1 Projection.xlsx"),
  q2 = import("G:/Analyst Folders/Lillian/exp_projection_year/projections/quarterly_outputs/archive/FY21 Q2 Projection.xlsx"),
  q3 = import("G:/Analyst Folders/Lillian/exp_projection_year/projections/quarterly_outputs/archive/FY21 Q3 Projection.xlsx")) %>%
  map(mutate_at, vars(ends_with("ID")), as.character) %>%
  map(group_by, `Agency Name`, `Object ID`)

proj$q1 <- proj$q1 %>%
  summarize(`Q1 Projection` = sum(`Q1 Projection`, na.rm = TRUE))
proj$q2 <- proj$q2 %>%
  summarize(`Q2 Projection` = sum(`Q2 Projection`, na.rm = TRUE))
proj$q3 <- proj$q3 %>%
  summarize(`Q3 Projection` = sum(`Q3 Projection`, na.rm = TRUE))

proj$final <- proj$q1 %>%
  full_join(proj$q2) %>%
  full_join(proj$q3)

df <- expend %>%
  filter(!is.na(`Agency ID`),
         `Fund Name` == "General") %>%
  mutate_at(vars(ends_with("ID")), as.character) %>%
  unite(col = "Object",  c(`Object ID`, `Object Name`), sep = " ") %>%
  group_by(`Agency Name`, Object) %>%
  summarize_at(vars(`Total Budget`, `BAPS YTD EXP`), sum, na.rm = TRUE) %>%
  rename(`FY21 Total Budget` = `Total Budget`, `FY21 Actual` = `BAPS YTD EXP`) %>%
  left_join(proj$final) %>%
  mutate_if(is.numeric, replace_na, 0) %>%
  mutate(
    `Q1 Difference` = `Q1 Projection` - `FY21 Actual`,
    `Q2 Difference` = `Q2 Projection` - `FY21 Actual`,
    `Q3 Difference` = `Q3 Projection` - `FY21 Actual`) %>%
  ungroup()

prep_data <- function(df, type) {
  
  if (type != "Citywide") {
    group <- c("FY21 Total Budget", "FY21 Actual", NULL, type)
    
    df <- df %>%
      group_by_at(type) %>%
      summarize_if(is.numeric, sum, na.rm = TRUE) 
    
  } else {
    group <- c("FY21 Total Budget", "FY21 Actual")
    
    df <- df %>%
      summarize_if(is.numeric, sum, na.rm = TRUE) 
  }
  
  df <- df %>%
    pivot_longer(starts_with("Q")) %>%
    separate(name, into = c("Quarter", "Type"), sep = " ", extra = "merge") %>%
    pivot_wider(names_from = "Type", values_from = "value") %>%
    bind_total_row(total_col = "Quarter", total_name = "GRAND TOTAL", 
                   group_col = c("FY21 Total Budget", "FY21 Actual", group)) %>%
    mutate(Projection = ifelse(Quarter == "GRAND TOTAL", Projection / 3, Projection),
           Difference = ifelse(Quarter == "GRAND TOTAL", Difference / 3, Difference),
           `Percent Change` = Difference / `FY21 Actual`)
  
  check <- df %>%
    filter(Quarter == "GRAND TOTAL") %>%
    summarize_at(vars(`FY21 Total Budget`, `FY21 Actual`), sum, na.rm = TRUE)
  
  assert_that(check$`FY21 Total Budget` == totals$`FY21 Total Budget`,
              check$`FY21 Actual` == totals$`FY21 Actual`)
  
  return(df)
}

```

- High accuracy: 1-3%
- Medium accuracy: 4-10%
- Low accuracy: 11%+
  
## Citywide accuracy
  
```{r citywide}

output <- prep_data(projections, "Citywide")

output %>%
  mutate(`Percent Change` = scales::percent(`Percent Change`, accuracy = 0.01),
         # using cell_spec instead of column_spec to set the background color bc the latter
         # colors the whole background, which is overwhelming
         `Percent Change` = cell_spec(`Percent Change`, 'html', color = "white", bold = TRUE,
                                      background= 
                                        case_when(abs(output$`Percent Change`) < .04 ~ "#69B34C",
                                                  abs(output$`Percent Change`) > .11 ~ "#FF0D0D",
                                                  TRUE ~ "#EFB700"))) %>%
  format_table_numbers() %>%
  format_table(total = TRUE, escape = FALSE) %>%
  collapse_rows(1:3, latex_hline = "major", valign = "top") 

```


## Object accuracy

Overall object accuracy is based on the percent change between the average of the `Projection` over all 3 quarters and the `FY21 Actual`.

```{r object, fig.height=10, fig.width=7, fig.align='center'}

output <- prep_data(projections, "Object")
```

```{r}
output %>%
  mutate(`Percent Change` = scales::percent(`Percent Change`, accuracy = 0.01),
         Projection = ifelse(Quarter == "GRAND TOTAL", paste(format_number(Projection, accuracy = 1L), "(avg)"),
                             format_number(Projection, accuracy = 1L)),
         Difference = ifelse(Quarter == "GRAND TOTAL", paste(format_number(Difference, accuracy = 1L), "(avg)"), 
                             format_number(Difference, accuracy = 1L)),
         # using cell_spec instead of column_spec to set the background color bc the latter
         # colors the whole background, which is overwhelming
         `Percent Change` = cell_spec(`Percent Change`, 'html', color = "white",  bold = TRUE,
                                      background= 
                                        case_when(abs(output$`Percent Change`) < .04 ~ "#69B34C",
                                                  abs(output$`Percent Change`) > .11 ~ "#FF0D0D",
                                                  TRUE ~ "#EFB700")),
         Object = cell_spec(Object, 'html', color = "white",  bold = TRUE,
                            background= 
                              case_when(abs(output$`Percent Change`) < .04 ~ "#69B34C",
                                        abs(output$`Percent Change`) > .11 ~ "#FF0D0D",
                                        TRUE ~ "#EFB700"))) %>%
  format_table_numbers() %>%
  format_table(total = TRUE, align = c("l", "l", rep("r", "5")), escape = FALSE) %>%
  row_spec(which(output$Quarter == "GRAND TOTAL"), bold = TRUE) %>%
  collapse_rows(1:4, latex_hline = "major", valign = "top") 
```


## Agency accuracy

Overall agency accuracy is based on the percent change between the average of the `Projection` over all 3 quarters and the `FY21 Actual`.

```{r agency, fig.height=40, fig.width=7, fig.align='center'}

output <- prep_data(projections, "Agency Name")

```


```{r agency table}
output %>%
  mutate(`Percent Change` = scales::percent(`Percent Change`, accuracy = 0.01),
         Projection = ifelse(Quarter == "GRAND TOTAL", paste(format_number(Projection, accuracy = 1L), "(avg)"),
                             format_number(Projection, accuracy = 1L)),
         Difference = ifelse(Quarter == "GRAND TOTAL", paste(format_number(Difference, accuracy = 1L), "(avg)"), 
                             format_number(Difference, accuracy = 1L)),
         # using cell_spec instead of column_spec to set the background color bc the latter
         # colors the whole background, which is overwhelming
         `Percent Change` = cell_spec(`Percent Change`, 'html', color = "white",  bold = TRUE,
                                      background= 
                                        case_when(abs(output$`Percent Change`) < .04 ~ "#69B34C",
                                                  abs(output$`Percent Change`) > .11 ~ "#FF0D0D",
                                                  TRUE ~ "#EFB700")),
         `Agency Name` = cell_spec(`Agency Name`, 'html', color = "white",  bold = TRUE,
                            background= 
                              case_when(abs(output$`Percent Change`) < .04 ~ "#69B34C",
                                        abs(output$`Percent Change`) > .11 ~ "#FF0D0D",
                                        TRUE ~ "#EFB700"))) %>%
  format_table_numbers() %>%
  format_table(total = TRUE, align = c("l", "l", rep("r", "5")), escape = FALSE) %>%
  row_spec(which(output$Quarter == "GRAND TOTAL"), bold = TRUE) %>%
  collapse_rows(1:4, latex_hline = "major", valign = "top") 

```
